<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel PSI</title>
<meta name="robots" content="noindex,nofollow">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  body { background:#0b1220; color:#e7eefc; font-family: system-ui; }
  .card { background:#111827; border: 1px solid #374151; color: #fff; }
  .table { color: #d1d5db; }
  .table-hover tbody tr:hover { color: #fff; background-color: #1f2937; }
  .form-control { background: #1f2937; border-color: #374151; color: #fff; }
  .form-control:focus { background: #1f2937; color: #fff; border-color: #6366f1; }
  .overlay { position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index: 9999; }
  .hidden { display: none !important; }
  .nav-pills .nav-link { color: #9ca3af; }
  .nav-pills .nav-link.active { background-color: #6366f1; color: white; }
  .form-control::placeholder {
      color: #b0b8c4 !important;  /* Gri deschis, vizibil pe fundal negru */
      opacity: 1; /* Fix pentru Firefox */
  }
</style>
</head>
<body class="p-3">

<div class="container" style="max-width: 1000px;">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="m-0"><i class="fa-solid fa-user-shield text-danger"></i> Admin PSI</h3>
    <div>
      <span id="statusBadge" class="badge bg-secondary me-2">Checking...</span>
      <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>

  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="tab-users" data-bs-toggle="pill" data-bs-target="#pills-users" type="button">ðŸ‘¥ Utilizatori</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-blacklist" data-bs-toggle="pill" data-bs-target="#pills-blacklist" type="button" onclick="loadBlacklist()">â›” Lista NeagrÄƒ</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-maint" data-bs-toggle="pill" data-bs-target="#pills-maint" type="button">ðŸ”§ MentenanÈ›Äƒ</button>
    </li>
  </ul>

  <div class="tab-content" id="pills-tabContent">
    
    <div class="tab-pane fade show active" id="pills-users">
      <div class="card p-3">
        <div class="d-flex gap-2 mb-3">
          <input type="text" id="searchInput" class="form-control" placeholder="CautÄƒ dupÄƒ telefon, firmÄƒ sau nume..." onkeyup="if(event.key==='Enter') loadUsers()">
          <button class="btn btn-primary" onclick="loadUsers()"><i class="fa-solid fa-search"></i></button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Telefon</th>
                <th>FirmÄƒ / Responsabil</th>
                <th class="text-center">Cod Ref</th>
                <th class="text-end">Credite</th>
                <th class="text-end" style="min-width: 100px;">AcÈ›iuni</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="5" class="text-center text-muted">ApasÄƒ CautÄƒ pentru a Ã®ncÄƒrca...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
<div class="tab-pane fade" id="pills-blacklist">
      <div class="card p-3">
        <div class="d-flex gap-2 mb-4 align-items-end">
          
          <div class="flex-grow-1">
            <label class="small text-white">AdaugÄƒ numÄƒr Ã®n Lista NeagrÄƒ:</label>
            <input type="text" id="blPhone" class="form-control" placeholder="Ex: 407xxxxxxxx">
          </div>
          
          <div class="flex-grow-1">
             <label class="small text-white">Motiv:</label>
             <input type="text" id="blReason" class="form-control" placeholder="Motiv blocare...">
          </div>
          
          <button class="btn btn-danger" onclick="addToBlacklist()"><i class="fa-solid fa-ban"></i> BlocheazÄƒ</button>
        </div>
        
    <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Telefon</th>
                <th>Data BlocÄƒrii</th>
                <th>Motiv</th>
                <th class="text-end">AcÈ›iuni</th>
              </tr>
            </thead>
            <tbody id="blacklistBody">
              <tr><td colspan="4" class="text-center text-muted">Se Ã®ncarcÄƒ...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pills-maint">
      <div class="card p-4 text-center" style="max-width: 500px; margin: 0 auto;">
        <h5>Stare Sistem</h5>
        <div class="my-3">
          <button class="btn btn-lg btn-danger w-100 mb-2" onclick="toggleMaint('on')">ðŸ›‘ PORNEÈ˜TE MENTENANÈšA</button>
          <button class="btn btn-lg btn-success w-100" onclick="toggleMaint('off')">âœ… OPREÈ˜TE MENTENANÈšA</button>
        </div>
        <pre id="maintOut" class="text-start bg-dark p-2 rounded small text-muted mt-3"></pre>
      </div>
    </div>

  </div>
</div>

<div class="overlay" id="overlay">
  <div class="card p-4" style="width: 100%; max-width: 400px;">
    <h4 class="mb-3 text-center">Admin Login</h4>
    <div id="step1">
      <input id="phone" class="form-control mb-3" placeholder="Telefon Admin (ex: 407xxxx)">
      <button class="btn btn-primary w-100" onclick="sendCode()">Trimite Cod</button>
    </div>
    <div id="step2" class="hidden">
      <input id="code" class="form-control mb-3" placeholder="Cod WhatsApp">
      <button class="btn btn-success w-100" onclick="verifyCode()">VerificÄƒ</button>
    </div>
    <div id="msg" class="mt-2 text-danger text-center small"></div>
  </div>
</div>

<div class="modal fade" id="creditModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Alimentare Credite</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="targetPhone">
        <div class="mb-3">
          <label>Utilizator:</label>
          <input type="text" id="targetNameDisplay" class="form-control" disabled>
        </div>
        <div class="mb-3">
          <label>Cantitate Credite:</label>
          <input type="number" id="addAmount" class="form-control" placeholder="ex: 100">
        </div>
        <div class="mb-3">
          <label>Motiv / Descriere:</label>
          <input type="text" id="addReason" class="form-control" value="AchiziÈ›ie pachet">
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">AnuleazÄƒ</button>
        <button type="button" class="btn btn-success" onclick="executeAddCredit()">ConfirmÄƒ</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API="/api.php";
const LS_OK="admin_ok_until";
const LS_PHONE="admin_phone";

function q(id){return document.getElementById(id);}
function norm(p){return p.replace(/\D/g,"");}
function isOk(){return Date.now()<Number(localStorage.getItem(LS_OK)||0);}

// --- AUTH ---
async function sendCode(){
  const tel = norm(q("phone").value);
  
  // 1. Folosim acÈ›iunea securizatÄƒ (admin_send_otp)
  const r = await fetch(`${API}?action=admin_send_otp&telefon=${tel}`);
  
  // 2. TratÄƒm rÄƒspunsul
  try {
    const j = await r.json();
    
    if(j.success){
      // Trecem la pasul 2 (introducere cod)
      q("step1").classList.add("hidden");
      q("step2").classList.remove("hidden");
      localStorage.setItem(LS_PHONE, tel);
      q("msg").textContent = "Cod trimis pe WhatsApp (Admin).";
    } else {
      // AfiÈ™Äƒm eroarea (ex: "Nu eÈ™ti admin")
      q("msg").textContent = j.message || "Eroare necunoscutÄƒ.";
    }
  } catch(e) {
    console.error(e);
    q("msg").textContent = "Eroare de comunicare cu serverul.";
  }
}

async function verifyCode(){
  const tel=localStorage.getItem(LS_PHONE);
  const cod=q("code").value;
  const r=await fetch(`${API}?action=verify&telefon=${tel}&cod=${cod}`);
  const j=await r.json();
  if(j.success){
    localStorage.setItem(LS_OK,Date.now()+8*60*60*1000);
    q("overlay").style.display="none";
    initAdmin();
  }else q("msg").textContent="Cod invalid";
}

function logout(){
  localStorage.removeItem(LS_OK);
  location.reload();
}

async function initAdmin(){
  if(!isOk()){ q("overlay").style.display="flex"; return; }
  q("overlay").style.display="none";
  checkMaintStatus();
  loadUsers();
}

// --- USERS ---
async function loadUsers(){
  const tel=localStorage.getItem(LS_PHONE);
  const search = q("searchInput").value;
  const r = await fetch(`${API}?action=admin_list_users&telefon=${tel}&q=${encodeURIComponent(search)}`);
  const j = await r.json();
  
  const tbody = q("usersBody");
  tbody.innerHTML = "";

  if(j.success && j.users){
    j.users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><small>${u.telefon}</small></td>
        <td>
          <div class="fw-bold text-white">${u.nume_societate || '-'}</div>
          <div class="small text-muted">${u.nume_responsabil || '-'}</div>
        </td>
        <td class="text-center"><span class="badge bg-dark border">${u.referral_code || '-'}</span></td>
        <td class="text-end fw-bold text-warning">${u.credite}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-success me-1" onclick="openCreditModal('${u.telefon}', '${u.nume_societate}')" title="AlimenteazÄƒ">
            <i class="fa-solid fa-plus"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.telefon}')" title="È˜terge Cont & BlocheazÄƒ">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    if(j.users.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nu am gÄƒsit utilizatori.</td></tr>';
  } else {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Eroare Ã®ncÄƒrcare.</td></tr>';
  }
}

async function deleteUser(phone){
  if(!confirm("âš ï¸ EÈ˜TI SIGUR?\n\nAcest cont va fi È˜TERS DEFINITIV, iar numÄƒrul va fi adÄƒugat Ã®n LISTA NEAGRÄ‚.")) return;
  
  const telAdmin = localStorage.getItem(LS_PHONE);
  const r = await fetch(`${API}?action=admin_delete_user&telefon=${telAdmin}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ targetPhone: phone })
  });
  const j = await r.json();
  
  if(j.success){
    alert("Cont È™ters È™i numÄƒr blocat.");
    loadUsers();
  } else {
    alert("Eroare: " + j.message);
  }
}

// --- CREDITS ---
const creditModal = new bootstrap.Modal(q('creditModal'));

function openCreditModal(phone, name){
  q('targetPhone').value = phone;
  q('targetNameDisplay').value = name || phone;
  q('addAmount').value = '';
  creditModal.show();
}

async function executeAddCredit(){
  const telAdmin = localStorage.getItem(LS_PHONE);
  const targetPhone = q('targetPhone').value;
  const amount = q('addAmount').value;
  const reason = q('addReason').value;

  if(!amount) return alert("Introdu cantitatea!");

  const r = await fetch(`${API}?action=admin_add_credit&telefon=${telAdmin}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ targetPhone, amount, reason })
  });
  const j = await r.json();
  
  if(j.success){
    creditModal.hide();
    loadUsers(); 
    alert("âœ… Alimentare reuÈ™itÄƒ!");
  } else {
    alert("Eroare: " + (j.message || "NecunoscutÄƒ"));
  }
}

// --- BLACKLIST ---
async function loadBlacklist(){
  const telAdmin = localStorage.getItem(LS_PHONE);
  const r = await fetch(`${API}?action=admin_get_blacklist&telefon=${telAdmin}`);
  const j = await r.json();

  const tbody = q("blacklistBody");
  tbody.innerHTML = "";

  if(j.success && j.list){
    j.list.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.telefon}</td>
        <td><small class="text-muted">${item.data_blocarii}</small></td>
        <td>${item.motiv || '-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-success" onclick="removeFromBlacklist('${item.telefon}')" title="DeblocheazÄƒ">
             <i class="fa-solid fa-unlock"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    if(j.list.length === 0) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Lista neagrÄƒ este goalÄƒ.</td></tr>';
  }
}

async function addToBlacklist(){
  const telAdmin = localStorage.getItem(LS_PHONE);
  const targetPhone = norm(q('blPhone').value);
  const motiv = q('blReason').value;

  if(!targetPhone) return alert("Scrie numÄƒrul de telefon.");

  const r = await fetch(`${API}?action=admin_add_blacklist&telefon=${telAdmin}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ targetPhone, motiv })
  });
  const j = await r.json();
  if(j.success){
    q('blPhone').value = '';
    loadBlacklist();
  } else {
    alert("Eroare: " + j.message);
  }
}

async function removeFromBlacklist(phone){
  if(!confirm(`Deblochezi numÄƒrul ${phone}?`)) return;
  
  const telAdmin = localStorage.getItem(LS_PHONE);
  const r = await fetch(`${API}?action=admin_remove_blacklist&telefon=${telAdmin}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ targetPhone: phone })
  });
  const j = await r.json();
  if(j.success){
    loadBlacklist();
  } else {
    alert("Eroare.");
  }
}

// --- MAINTENANCE ---
async function checkMaintStatus(){
  const r=await fetch(`${API}?action=maintenance_status`);
  const j=await r.json();
  const el = q("statusBadge");
  if(j.active){
    el.className = "badge bg-danger me-2";
    el.textContent = "MENTENANÈšÄ‚ ACTIVÄ‚";
  } else {
    el.className = "badge bg-success me-2";
    el.textContent = "Sistem Online";
  }
  q("maintOut").textContent = JSON.stringify(j, null, 2);
}

async function toggleMaint(state){ // 'on' or 'off'
  const tel=localStorage.getItem(LS_PHONE);
  const r=await fetch(`${API}?action=maintenance_${state}&telefon=${tel}`);
  await r.text();
  checkMaintStatus();
}

// Start
initAdmin();
</script>
</body>
</html>